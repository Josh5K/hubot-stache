<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Stache Overflow</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">
  <style>
    div.canvas-wrapper {
      position: absolute;
      width: 640px;
      height: 480px;
      left: 50%
    }
    
    #baseCanvas {
      position: relative;
      left: -50%;
    }
    
    #overlayCanvas {
      position: absolute;
      top: 0;
      left: -50%;
    }
    
    input[type=range] {
      width: 100%;
    }
  </style>

</head>

<body>
  <div class="container">

    <h1 class="text-center">Stache Overflow</h1>
    <div class="canvas-wrapper">
      <canvas id="baseCanvas" width="640" height="480"></canvas>
      <canvas id="overlayCanvas" width="640" height="480"></canvas>
    </div>
    <div class="row" style="margin-top: 510px">
      <div class="col-3">
        <p>Feature Anchor</p>
        <div class="form-group">
          <select class="form-control" name="" id="feature-select">
            <option value="eyeLeft">Eye</option>
            <option selected="selected" value="mouthLeft">Mouth</option>
            <option value="nose">Nose</option>
          </select>
        </div>
      </div>
      <div class="col-3">
        <p>Select Stache</p>
        <div class="form-group">
          <select class="form-control" name="" id="stache-select">
          </select>
        </div>
      </div>
      <div class="col-3">
        <p>
          Upload Custom<br>
          <small>Should be a unique, descriptive filename)</small>
        </p>
        <div class="form-group">
          <input type="file" id="stache-upload" accept="image/png,image/x-png,image/gif,image/jpeg">
          <br><br>
          <button type="button" onclick="uploadStache()" class="btn btn-primary">Upload</button>
        </div>
      </div>
      <div class="col-3">
        <p>Save Profile<br>
          <small>This will save the current config for this stache so that you can use it with hubot-stache</small>
        </p>
        <button type="button" onclick="saveProfile()" class="btn btn-success">Save</button>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <p>Scale</p>
        <input id="s-slider" value="1" type="range" min="0" max="5" step="0.01">
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <p>Horizontal Offset</p>
        <input id="h-slider" type="range" min="0" max="1280" step="1">
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <p>Vertical Offset</p>
        <input id="v-slider" type="range" min="0" max="960" step="1">
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <p>Config Data</p>
        <code id="config-data"></code>
      </div>
    </div>

  </div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script>
  <script src="http://underscorejs.org/underscore-min.js"></script>
  <script>
    var testSubject = "H1BbSf8zZ" //use http://localhost:8888/stacheoverflow/config/face/H1BbSf8zZ

    var configData, stacheOffsetX, stacheOffsetY, feature, scaleFactor, stacheX, stacheY, stacheWidth, stacheHeight, x_nose, y_nose, x_mouthLeft, y_mouthLeft, x_mouthRight, y_mouthRight, x_eyeLeft, y_eyeLeft, x_eyeRight, y_eyeRight
    var baseCanvas = document.getElementById('baseCanvas');
    var overlayCanvas = document.getElementById('overlayCanvas');
    var facectx = baseCanvas.getContext('2d');
    var stachectx = overlayCanvas.getContext('2d');
    facectx.scale(0.5, 0.5)
    stachectx.scale(0.5, 0.5)
    var face = new Image();
    var stache = new Image();
    function drawConfigData() {
      // -geometry (stache.width * scaleFactor)x+(x_mouthLeft)
      feature = $("#feature-select").val()
      stacheOffsetX = Math.floor(stacheX - eval(`x_${feature}`))
      stacheOffsetY = Math.floor(stacheY - eval(`y_${feature}`))
      // console.log(`Stache X position ${stacheX}`) //Unknown
      // console.log(`Stache Y position ${stacheY}`) //Unknown
      // console.log(`Slider X value ${document.getElementById("h-slider").value}`) //N/A
      // console.log(`Slider Y value ${document.getElementById("v-slider").value}`) //N/A
      // console.log(`Feature X position ${eval(`x_${feature}`)}`) //known
      // console.log(`Feature Y position ${eval(`y_${feature}`)}`) //known
      // console.log(`Stache X Offset ${stacheOffsetX}`) //known
      // console.log(`Stache Y Offset ${stacheOffsetY}`) //known
      // console.log(`Formula: (stache.width * scaleFactor)x+(stacheOffsetX + x_feature)+(stacheOffsetY + y_feature)`)
      // console.log(`---`)

      // document.getElementById('config-data').innerHTML  = `convert /home/jordan/dev/nubot/node_modules/hubot-stache/src/public/faces/jason.jpg \
      //  /home/jordan/dev/nubot/node_modules/hubot-stache/src/public/templates/stache.png \
      //  -geometry ${Math.floor(stache.width * scaleFactor)}x+${Math.floor(stacheOffsetX + eval(`x_${feature}`))}+${Math.floor(stacheOffsetY + eval(`y_${feature}`))} -composite \
      //  /tmp/jason.jpg`
      configData = { "id": document.getElementById('stache-select').value, "fileName": $('#stache-select option:selected').html(), "featureAnchor": feature, "offsetX": stacheOffsetX, "offsetY": stacheOffsetY, "scaleFactor": scaleFactor }
      document.getElementById('config-data').innerHTML = JSON.stringify(configData)
    }

    function resetSliderPositions(x, y) {
      document.getElementById("h-slider").value = x
      document.getElementById("v-slider").value = y
    }
    function saveProfile() {
      console.log(`Attempting to save stache profile: ${JSON.stringify(configData)}`)
      $.ajax("/stacheoverflow/config/stache", {
        data: JSON.stringify(configData),
        contentType: "application/json",
        type: "POST"
      }).fail(function (data, status) {
        console.error(data, status)
        alert(`Error saving profile: ${data.status} ${data.statusText}`)
      }).done(function (data, status) {
        alert('Profile Saved!')
      })
    }
    function uploadStache() {
      console.log(`Attempting to upload stache`)
      var data = new FormData();
      $.each($('#stache-upload')[0].files, function (i, file) {
        data.append('image', file);
      });
      $.ajax({
        url: '/stacheoverflow/image/stache',
        data: data,
        cache: false,
        contentType: false,
        processData: false,
        type: 'POST'
      }).fail(function (data, status) {
        console.error(data, status)
        alert(`Error uploading stache: ${data.status} ${data.statusText}`)
      }).done(function (data, status) {
        alert('Stache Uploaded!')
        populateStacheSelector()
      })
    }
    // Populate Dropdown Array with staches
    function populateStacheSelector() {
      $.getJSON('/stacheoverflow/config/stache', function (options) {
        var select = document.getElementById('stache-select')
        $(select).empty()
        for (var i = 0; i < options.length; i++) {
          var opt = options[i];
          var el = document.createElement("option");
          el.textContent = opt.fileName;
          el.value = opt.id;
          select.appendChild(el);
        }
      })
    }
    populateStacheSelector()


    face.onload = function () {
      facectx.drawImage(face, 0, 0);
      $.getJSON(`/stacheoverflow/config/face/${testSubject}`, function (response) {
        facedata = response.data.FaceDetails[0]
        facectx.fillStyle = "#FFFF00";
        var landmarks = facedata.Landmarks;
        var nose = _.findWhere(landmarks, {
          'Type': 'nose'
        });
        x_nose = nose.X * face.width;
        y_nose = nose.Y * face.height;
        facectx.fillRect(x_nose, y_nose, 5, 5);

        var mouthLeft = _.findWhere(landmarks, {
          'Type': 'mouthLeft'
        });

        x_mouthLeft = mouthLeft.X * face.width;
        y_mouthLeft = mouthLeft.Y * face.height;
        facectx.fillRect(x_mouthLeft, y_mouthLeft, 5, 5);

        var mouthRight = _.findWhere(landmarks, {
          'Type': 'mouthRight'
        });
        x_mouthRight = mouthRight.X * face.width;
        y_mouthRight = mouthRight.Y * face.height;
        var mouthWidth = x_mouthRight - x_mouthLeft;
        facectx.fillRect(x_mouthRight, y_mouthRight, 5, 5);


        var eyeLeft = _.findWhere(landmarks, {
          'Type': 'eyeLeft'
        });
        x_eyeLeft = eyeLeft.X * face.width;
        y_eyeLeft = eyeLeft.Y * face.height;
        facectx.fillRect(x_eyeLeft, y_eyeLeft, 5, 5);

        var eyeRight = _.findWhere(landmarks, {
          'Type': 'eyeRight'
        });
        x_eyeRight = eyeRight.X * face.width;
        y_eyeRight = eyeRight.Y * face.height;
        facectx.fillRect(x_eyeRight, y_eyeRight, 5, 5);

        stache.onload = function () {
          stacheX = x_mouthLeft
          stacheY = y_mouthLeft
          scaleFactor = 1
          feature = $("#feature-select").val()
          stacheWidth = stache.width
          stacheHeight = stache.height
          stachectx.drawImage(stache, stacheX, stacheY);
          drawConfigData() //Draw the init config data after both images have loaded
        };
        stache.src = `/stacheoverflow/image/stache/${document.getElementById('stache-select').value}`
      }); //end get testdata json
    };
    face.src = `/stacheoverflow/image/face/${testSubject}`;


    // Bind onChange events
    $("#h-slider").on("input change", function () {
      stacheX = this.value
      stachectx.clearRect(0, 0, 1280, 960)
      stachectx.drawImage(stache, stacheX, stacheY, stacheWidth, stacheHeight);
      drawConfigData()
    })
    $("#v-slider").on("input change", function () {
      stacheY = this.value
      stachectx.clearRect(0, 0, 1280, 960)
      stachectx.drawImage(stache, stacheX, stacheY, stacheWidth, stacheHeight);
      drawConfigData()
    })
    $("#s-slider").on("input change", function () {
      scaleFactor = this.value
      stacheWidth = stache.width * scaleFactor
      stacheHeight = stache.height * scaleFactor
      feature = $('#feature-select').val()
      stacheX = eval(`x_${feature}`)
      stacheY = eval(`y_${feature}`)
      resetSliderPositions(stacheX, stacheY)
      stachectx.clearRect(0, 0, 1280, 960)
      stachectx.drawImage(stache, stacheX, stacheY, stacheWidth, stacheHeight);
      drawConfigData()
    })
    $("#feature-select").on("input change", function () {
      stachectx.clearRect(0, 0, 1280, 960)
      feature = this.value
      stacheX = eval(`x_${feature}`)
      stacheY = eval(`y_${feature}`)
      resetSliderPositions(stacheX, stacheY)
      stachectx.drawImage(stache, stacheX, stacheY, stacheWidth, stacheHeight);
      drawConfigData()
    })
    $("#stache-select").on("input change", function () {
      stache.src = `/stacheoverflow/image/stache/${this.value}`
      stachectx.clearRect(0, 0, 1280, 960)
      feature = $("#feature-select").val()
      stacheX = eval(`x_${feature}`)
      stacheY = eval(`y_${feature}`)
      resetSliderPositions(stacheX, stacheY)
      document.getElementById("s-slider").value = 1 // also reset the scale slider when changing staches
      drawConfigData()
    })
  </script>
</body>

</html>